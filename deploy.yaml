resources:
- type: compute.v1.instance
  name: www1
  properties:
    machineType: zones/us-central1-a/machineTypes/n1-standard-1
    # The properties of the resource depend on the type of resource. For a list
    # of properties, see the API reference for the resource.
    zone: us-central1-a
    tags:
      items:
      - network-lb-tag
    networkInterfaces:
    - network: global/networks/default
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
#    networkInterfaces:
#    - network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/default
#      accessConfigs:
#      - name: External NAT
#        type: ONE_TO_ONE_NAT
    disks:
    - deviceName: boot
      boot: true
      initializeParams:
        # See a full list of image families at https://cloud.google.com/compute/docs/images#os-compute-support
        # The format of the sourceImage URL is: https://www.googleapis.com/compute/v1/projects/[IMAGE_PROJECT]/global/images/family/[FAMILY_NAME]
        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/family/debian-9
    metadata:
      items:
      - key: startup-script
        value: "#! /bin/bash\n    sudo apt-get update\n    sudo apt-get install apache2 -y\n    sudo service apache2 restart\n    echo '<!doctype html><html><body><h1>www1</h1></body></html>' | tee /var/www/html/index.html"

- type: compute.v1.instance
  name: www2
  properties:
    machineType: zones/us-central1-a/machineTypes/n1-standard-1
    zone: us-central1-a
    tags:
      items:
      - network-lb-tag
    networkInterfaces:
    - network: global/networks/default
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
    disks:
    - deviceName: boot
      boot: true
      initializeParams:
        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/family/debian-9
    metadata:
      items:
      - key: startup-script
        value: "#! /bin/bash\n    sudo apt-get update\n    sudo apt-get install apache2 -y\n    sudo service apache2 restart\n    echo '<!doctype html><html><body><h1>www2</h1></body></html>' | tee /var/www/html/index.html"

- type: compute.v1.instance
  name: www3
  properties:
    machineType: zones/us-central1-a/machineTypes/n1-standard-1
    zone: us-central1-a
    tags:
      items:
      - network-lb-tag
    networkInterfaces:
    - network: global/networks/default
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
    disks:
    - deviceName: boot
      boot: true
      initializeParams:
        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/family/debian-9
    metadata:
      items:
      - key: startup-script
        value: "#! /bin/bash\n    sudo apt-get update\n    sudo apt-get install apache2 -y\n    sudo service apache2 restart\n    echo '<!doctype html><html><body><h1>www3</h1></body></html>' | tee /var/www/html/index.html"

- type: compute.v1.firewall
  name: www-firewall-network-lb
  properties:
    targetTags:
    - network-lb-tag
    allowed:
    - IPProtocol: tcp
      ports:
      - '80'

- type: compute.v1.address
  name: network-lb-ip-1
  properties:
    region: us-central1

- type: compute.v1.httpHealthCheck
  name: basic-check

- type: compute.v1.targetPool
  name: www-pool
  properties:
    region: us-central1
    healthChecks:
    - $(ref.basic-check.selfLink)
    instances:
    - $(ref.www1.selfLink)
    - $(ref.www2.selfLink)
    - $(ref.www3.selfLink)

- type: compute.v1.forwardingRule
  name: www-rule
  properties:
    region: us-central1
    ports:
    - '80'
    IPAddress: $(ref.network-lb-ip-1.selfLink)
    target: www-pool

- type: compute.v1.instanceTemplate
  name: lb-backend-template
  properties:
    region: us-central1
    networkInterfaces:
    - network: global/networks/default
      subnetwork: default
    tags:
      items:
      - allow-health-check
    disks:
    - deviceName: boot
      initializeParams:
        sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/family/debian-9
  metadata:
    items:
    - key: startup-script
      value: |
        #! /bin/bash
        apt-get update
        apt-get install apache2 -y
        a2ensite default-ssl
        a2enmod ssl
        vm_hostname="$(curl -H "Metadata-Flavor:Google" \
        http://169.254.169.254/computeMetadata/v1/instance/name)"
        echo "Page served from: $vm_hostname" | \
        tee /var/www/html/index.html
        systemctl restart apache2


- type: compute.v1.instanceGroupManager
  name: lb-backend-group
  properties:
    instanceTemplate: $(ref.lb-backend-template.selfLink)
    targetSize: 2
    zone: us-central1-a

- type: compute.v1.firewall
  name: fw-allow-health-check
  properties:
    sourceRanges:
    - 130.211.0.0/22
    - 35.191.0.0/16
    targetTags:
    - allow-health-check
    allowed:
    - IPProtocol: tcp
      ports:
      - '80'

- type: compute.v1.globalAddress
  name: lb-ipv4-1
  properties:
    ipVersion: IPV4

- type: compute.v1.httpHealthCheck
  name: http-basic-check

- type: compute.v1.backendService
  name: web-backend-service
  properties:
    protocol: HTTP
    portName: http
    healthChecks:
    - $(ref.http-basic-check.selfLink)
    # backends:
    # - $(ref.web-backend-service.selfLink)
    group: $(ref.lb-backend-group.selfLink)

- type: compute.v1.urlMap
  name: web-map-http
  properties:
    defaultService: $(ref.web-backend-service.selfLink)

- type: compute.v1.targetHttpProxy
  name: http-lb-proxy
  properties:
    urlMap: $(ref.web-map-http.selfLink)

- type: compute.v1.globalForwardingRule
  name: http-content-rule
  properties:
    ports:
    - '80'
    IPAddress: lb-ipv4-1
    target: $(ref.http-lb-proxy.selfLink)
